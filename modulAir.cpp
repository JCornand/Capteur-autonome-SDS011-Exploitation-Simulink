#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>  // UNIX standard function definitions 
#include <fcntl.h>   // File control definitions
#include <errno.h>   // Error number definitions 
#include <termios.h> // POSIX terminal control definitions 

int main(int argc, char *argv[])
{
	//
	//déclaration de mes vairables
	int fd_air, n;
	char commande [9];
	char retour[9];
	long int res;

	//
	//test du passage de paramètres
	if(argc != 2){
		printf("2 paramètres attendus veillez refaire, 2 ème argument /dev/ttyUSB0 ou 1\n");
		exit(1);
	}

	printf("Le nombre d'argments passer est:%d\n\n",argc);
	printf("Nom de l'éxé: %s\nCommunication sur: %s\n",argv[0],argv[1]);


	//
	//param_liaison_serie=(9600,N,8,1);
	fd_air = open(argv[1],O_RDWR | O_NOCTTY | O_NDELAY); //| O_NDELAY);// /dev/ttyS0 port 1 de linus,ndelay ne mets pas ne pause le programme si problème avec DCD
	//rdwr pour lire et écrire,RDONLY pour lire uniquement
	fcntl(fd, F_SETFL, FNDELAY);
	struct termios options;

	if (fd_air == -1){
	  
	  	printf("\nerreur ouverture port série\n");
	  	exit(1);
	  }
	else{
		printf("\nport série ouvert\n");
	}

	
	tcgetattr(fd_air, &options);//cherche les paramètres de la liason et les mets dans la struct
	options.c_cflag &= ~PARENB;
	options.c_cflag &= ~CSTOPB;
	options.c_cflag &= ~CSIZE;
	options.c_cflag |= CS8;
	cfsetispeed(&options, B9600);cfsetospeed(&options, B9600);//définis la vitesse ici 4800bauds
	options.c_cflag |= (CLOCAL | CREAD);
	tcsetattr(fd_air, TCSANOW, &options);//rentre les paramètres dedans


	//
	//préparation de la commande read gas concentration
	
	commande[0]=0XFF;
	commande[1]=0x01;
	commande[2]=0x86;
	commande[3]=0x00;
	commande[4]=0x00;
	commande[5]=0x00;
	commande[6]=0x00;
	commande[7]=0x00;
	commande[8]=0x79;
	
    //
	//émettre la commande read gas concentration
	while(1){
		n = write(fd_air, commande, 9);
		if (n < 0){
		perror("Write\n");
		close(fd_air);//ferme le socket
		exit(0);
		}

		printf("écriture réussit\n");

		//
		//lire
	
		read(fd_air,&retour,9);

		//
		//calcul
		res = retour[2]*256+retour[3];
	
		//
		//afficher 
		printf("La concentration de co2 est de:%ldppm\n",res);
		sleep(1);
	}
	
	
	close(fd_air);//ferme le socket

	exit(0);
}
